<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn Typing - CalciPrep</title>
    <meta name="description" content="Learn touch typing from the ground up with guided lessons and exercises.">
    <link rel="canonical" href="https://calciprep.online/learn-typing.html" />
    <link rel="icon" type="image/svg+xml" href="/media/favicon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        .tab-link.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight:600; }
        .content-panel { display:none; }
        .content-panel.active { display:block; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        
        /* Ad container styles */
        .ad-container {
            min-height: 600px;
            width: 100%;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        /* Learn Keys Section Styles */
        #exercise-display-area, #words-display-area, #paragraph-display-area { font-size:1.5rem; line-height:2rem; letter-spacing:0.02em; word-spacing:0.05em; }
        #typing-input-area, #words-typing-input, #paragraph-typing-input { 
            caret-color: #10b981; 
        }
        #typing-input-area, #words-typing-input, #paragraph-typing-input {
             border-width: 2px;
        }

        #typing-input-area:focus, #words-typing-input:focus, #paragraph-typing-input:focus {
             outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #10b981; /* green-500 */
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.5);
        }
        .correct-char { color: #16a34a; }
        .incorrect-char { color: #dc2626; text-decoration: underline; }
        .current-char { background-color: #d1fae5; }
    </style>
</head>
<body class="text-slate-800">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-4 max-w-7xl mx-auto">
            <button id="ts-back-button" class="text-sm text-green-600 hover:text-green-800 font-medium">&larr; Back to Typing Selection</button>
        </div>
        <div class="flex justify-center gap-8">
            <!-- Left Ad Container -->
            <aside class="w-40 hidden xl:block">
                <div class="sticky top-28 ad-container">
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2382040431534049"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2382040431534049"
                         data-ad-slot="4929439151"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                        if (document.currentScript.parentElement.offsetParent !== null) {
                           (adsbygoogle = window.adsbygoogle || []).push({});
                        }
                    </script>
                </div>
            </aside>
            
            <!-- Main Content -->
            <div class="flex-grow max-w-4xl">
                <!-- Step Navigation -->
                <nav class="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm mb-8">
                    <a href="#" class="tab-link border-b-2 border-transparent px-4 py-2 transition-colors duration-200 text-slate-600 hover:text-indigo-600 active" data-target="panel-1">1. Read Instructions</a>
                    <span class="text-slate-300 mx-2 hidden sm:inline">----&gt;</span>
                    <a href="#" class="tab-link border-b-2 border-transparent px-4 py-2 transition-colors duration-200 text-slate-600 hover:text-indigo-600" data-target="panel-2">2. Learn Keys</a>
                    <span class="text-slate-300 mx-2 hidden sm:inline">----&gt;</span>
                    <a href="#" class="tab-link border-b-2 border-transparent px-4 py-2 transition-colors duration-200 text-slate-600 hover:text-indigo-600" data-target="panel-3">3. Practice Words</a>
                    <span class="text-slate-300 mx-2 hidden sm:inline">----&gt;</span>
                    <a href="#" class="tab-link border-b-2 border-transparent px-4 py-2 transition-colors duration-200 text-slate-600 hover:text-indigo-600" data-target="panel-4">4. Type Paragraphs</a>
                </nav>

                <!-- Content Panels -->
                <div id="panel-1" class="content-panel active text-sm">
                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-sm">
                        <h2 class="text-base font-semibold mb-2">Where to put fingers on a QWERTY keyboard</h2>
                        <p class="text-gray-600">Keyboards like those are widely used are QWERTY keyboards. Before start learning typing you must know where to put your fingers. place your fingers like this (see picture)</p>
                        
                        <div class="my-6 flex justify-center">
                            <img src="media/instructions.png" alt="Keyboard finger placement guide" class="max-w-xl w-full border rounded-lg shadow-sm">
                        </div>

                        <ul class="list-disc list-inside space-y-1 text-gray-700">
                            <li>index finger of left hand should be on 'F' key.</li>
                            <li>index finger of right hand finger on 'J' key.</li>
                            <li>both thumbs should be on 'space' key.</li>
                        </ul>
                        <p class="mt-4 font-semibold text-center">* Best of luck *</p>
                        <div class="mt-6 text-center">
                            <button id="start-learning-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition-colors">Start Learning</button>
                        </div>
                    </div>
                </div>

                <div id="panel-2" class="content-panel">
                    <div class="bg-green-100 p-2 sm:p-4 rounded-lg shadow-sm border-2 border-green-500">
                        <div id="exercise-display-area" class="w-full h-64 p-4 font-mono text-gray-700 bg-white rounded-lg border border-slate-200 overflow-y-auto whitespace-pre-wrap select-none"></div>
                        <div class="flex justify-between items-center mt-2 px-2 py-1">
                            <div class="flex items-center space-x-2">
                                <button id="prev-exercise" class="p-2 rounded-md hover:bg-slate-100 disabled:opacity-50" title="Previous Exercise">&lt;&lt;</button>
                                <select id="category-select" class="text-sm px-2 py-1 border rounded bg-white" aria-label="Select category"></select>
                                <select id="exercise-select" class="text-sm px-2 py-1 border rounded bg-white" aria-label="Select exercise"></select>
                                <button id="next-exercise" class="p-2 rounded-md hover:bg-slate-100" title="Next Exercise">&gt;&gt;</button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="font-decrease" class="p-2 rounded-md hover:bg-slate-100 text-sm">A-</button>
                                <button id="font-increase" class="p-2 rounded-md hover:bg-slate-100 text-sm">A+</button>
                                <label class="inline-flex items-center text-sm ml-2">
                                    <input id="typing-sound-checkbox" type="checkbox" class="mr-1.5 rounded text-green-600 focus:ring-green-500"/>
                                    <span>Sound</span>
                                </label>
                            </div>
                        </div>
                        <textarea id="typing-input-area" class="w-full h-48 mt-2 p-4 font-mono text-lg bg-white rounded-lg border-2 border-slate-300" placeholder="Start typing here..."></textarea>
                        <div class="mt-3 text-right">
                            <button id="typing-submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Submit</button>
                        </div>
                    </div>
                </div>
                
                <div id="panel-3" class="content-panel">
                    <div class="bg-green-100 p-2 sm:p-4 rounded-lg shadow-sm border-2 border-green-500">
                        <div id="words-display-area" class="w-full h-64 p-4 font-mono text-gray-700 bg-white rounded-lg border border-slate-200 overflow-y-auto whitespace-pre-wrap select-none"></div>
                        <div class="flex justify-between items-center mt-2 px-2 py-1">
                            <div class="flex items-center space-x-2">
                                <button id="prev-words" class="p-2 rounded-md hover:bg-slate-100 disabled:opacity-50" title="Previous Words">&lt;&lt;</button>
                                <select id="words-select" class="text-sm px-2 py-1 border rounded bg-white" aria-label="Select word category"></select>
                                <button id="next-words" class="p-2 rounded-md hover:bg-slate-100" title="Next Words">&gt;&gt;</button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="words-font-decrease" class="p-2 rounded-md hover:bg-slate-100 text-sm">A-</button>
                                <button id="words-font-increase" class="p-2 rounded-md hover:bg-slate-100 text-sm">A+</button>
                                <label class="inline-flex items-center text-sm ml-2">
                                    <input id="words-sound-checkbox" type="checkbox" class="mr-1.5 rounded text-green-600 focus:ring-green-500"/>
                                    <span>Sound</span>
                                </label>
                            </div>
                        </div>
                        <textarea id="words-typing-input" class="w-full h-48 mt-2 p-4 font-mono text-lg bg-white rounded-lg border-2 border-slate-300" placeholder="Start typing the words here..."></textarea>
                        <div class="mt-3 text-right">
                            <button id="words-submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Submit</button>
                        </div>
                    </div>
                </div>
                
                <div id="panel-4" class="content-panel">
                    <div class="bg-green-100 p-2 sm:p-4 rounded-lg shadow-sm border-2 border-green-500">
                        <div id="paragraph-display-area" class="w-full h-64 p-4 font-mono text-gray-700 bg-white rounded-lg border border-slate-200 overflow-y-auto whitespace-pre-wrap select-none"></div>
                        <div class="flex justify-between items-center mt-2 px-2 py-1">
                            <div class="flex items-center space-x-2">
                                <button id="prev-paragraph" class="p-2 rounded-md hover:bg-slate-100 disabled:opacity-50" title="Previous Paragraph">&lt;&lt;</button>
                                <select id="paragraph-select" class="text-sm px-2 py-1 border rounded bg-white" aria-label="Select paragraph"></select>
                                <button id="next-paragraph" class="p-2 rounded-md hover:bg-slate-100" title="Next Paragraph">&gt;&gt;</button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="paragraph-font-decrease" class="p-2 rounded-md hover:bg-slate-100 text-sm">A-</button>
                                <button id="paragraph-font-increase" class="p-2 rounded-md hover:bg-slate-100 text-sm">A+</button>
                                <label class="inline-flex items-center text-sm ml-2">
                                    <input id="paragraph-sound-checkbox" type="checkbox" class="mr-1.5 rounded text-green-600 focus:ring-green-500"/>
                                    <span>Sound</span>
                                </label>
                            </div>
                        </div>
                        <textarea id="paragraph-typing-input" class="w-full h-48 mt-2 p-4 font-mono text-lg bg-white rounded-lg border-2 border-slate-300" placeholder="Start typing the paragraph here..."></textarea>
                        <div class="mt-3 text-right">
                            <button id="paragraph-submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Right Ad Container -->
            <aside class="w-40 hidden xl:block">
                <div class="sticky top-28 ad-container">
                     <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2382040431534049"
                         crossorigin="anonymous"></script>
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-2382040431534049"
                         data-ad-slot="4929439151"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                    <script>
                        if (document.currentScript.parentElement.offsetParent !== null) {
                           (adsbygoogle = window.adsbygoogle || []).push({});
                        }
                    </script>
                </div>
            </aside>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <div id="result-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30 hidden">
    <div class="bg-white w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 max-h-[80vh] overflow-y-auto border rounded shadow-lg p-6 card-glow" style="position:relative;">
            <div class="flex items-start justify-between mb-4">
                <h3 id="result-title" class="text-center text-lg font-semibold underline">Detailed Result as below</h3>
                <div class="flex items-center space-x-2">
                    <button id="res-close" title="Close" class="w-8 h-8 rounded-full flex items-center justify-center bg-red-500 text-white hover:opacity-90" aria-label="Close"><span style="font-weight:700;line-height:0">✕</span></button>
                    <button id="res-minimize" title="Minimize" class="w-8 h-8 rounded-full flex items-center justify-center bg-green-500 text-white hover:opacity-90" aria-label="Minimize"><span style="font-weight:700;line-height:0">–</span></button>
                </div>
            </div>
            <div id="result-content" class="text-sm text-slate-800">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 border-b pb-4">
                    <div>
                        <div class="flex justify-between"><span class="font-medium">Test Duration</span><span id="res-duration">: 00 minutes 00 seconds</span></div>
                        <div class="flex justify-between mt-2"><span class="font-medium">Correct Words Typed</span><span id="res-correct-words">: 0</span></div>
                    </div>
                    <div>
                        <div class="flex justify-between"><span class="font-medium">Total Words Typed</span><span id="res-total-words">: 0</span></div>
                        <div class="flex justify-between mt-2"><span class="font-medium">Incorrect Words Typed</span><span id="res-incorrect-words">: 0</span></div>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="text-slate-500 italic mb-2">Method 1 <span class="text-xs">(one word = 5 character or key strokes)</span></div>
                    <div class="grid grid-cols-2 gap-2 pl-4">
                        <div class="text-slate-700">Net Speed</div><div id="m1-net" class="text-slate-900">: 0 words per minute</div>
                        <div class="text-slate-700">: </div><div id="m1-net-strokes" class="text-slate-900">: 0 key strokes per minute</div>
                        <div class="text-slate-700">Gross Speed</div><div id="m1-gross" class="text-slate-900">: 0 words per minute</div>
                        <div class="text-slate-700">: </div><div id="m1-gross-strokes" class="text-slate-900">: 0 key strokes per minute</div>
                        <div class="text-slate-700">Accuracy</div><div id="m1-accuracy" class="text-slate-900">: 0%</div>
                        <div class="text-slate-700">Backspace</div><div id="m1-backspace" class="text-slate-900">: 0 times</div>
                    </div>
                </div>
                <div class="mb-4">
                    <div class="text-slate-500 italic mb-2">Method 2 <span class="text-xs">(one word = group of letters separated by space)</span></div>
                    <div class="grid grid-cols-2 gap-2 pl-4">
                        <div class="text-slate-700">Net Speed</div><div id="m2-net" class="text-slate-900">: 0 words per minute</div>
                        <div class="text-slate-700">: </div><div id="m2-net-strokes" class="text-slate-900">: 0 key strokes per minute</div>
                        <div class="text-slate-700">Gross Speed</div><div id="m2-gross" class="text-slate-900">: 0 words per minute</div>
                        <div class="text-slate-700">: </div><div id="m2-gross-strokes" class="text-slate-900">: 0 key strokes per minute</div>
                        <div class="text-slate-700">Accuracy</div><div id="m2-accuracy" class="text-slate-900">: 0%</div>
                        <div class="text-slate-700">Backspace</div><div id="m2-backspace" class="text-slate-900">: 0 times</div>
                    </div>
                </div>
                <div class="text-xs text-slate-500">Note : Key depressions, characters and key strokes are same thing.</div>
            </div>
            <div class="flex justify-between items-center mt-6">
                <button id="res-repeat" class="bg-white border px-4 py-2 rounded hover:bg-slate-50">Repeat</button>
                <button id="res-next" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Next&gt;&gt;</button>
            </div>
        </div>
    </div>

    <div id="result-minimized" class="fixed right-4 bottom-4 z-60 bg-white border rounded shadow px-4 py-2 hidden">
        <div class="flex items-center space-x-3">
            <div id="min-summary" class="text-sm text-slate-700">Result summary</div>
            <button id="min-restore" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm">Show</button>
        </div>
    </div>

    <script src="templates.js"></script>
    <script type="module" src="main.js"></script>
    <script>
    // Consolidated script: tabs, fetch exercises, typing tracking, SSC-style scoring, result modal + minimize
    document.addEventListener('DOMContentLoaded', () => {
        // Tabs
        const tabs = document.querySelectorAll('.tab-link');
        const panels = document.querySelectorAll('.content-panel');
        const startLearningBtn = document.getElementById('start-learning-btn');
        const backToSelectionBtn = document.getElementById('ts-back-button');
        if (backToSelectionBtn) backToSelectionBtn.addEventListener('click', (e)=>{ e.preventDefault(); if(window.history && window.history.length>1) window.history.back(); else window.location.href = 'typing-selection.html'; });
        function switchTab(id){ panels.forEach(p=>p.classList.toggle('active', p.id===id)); tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===id)); }
        tabs.forEach(t=>t.addEventListener('click',(e)=>{ e.preventDefault(); switchTab(t.dataset.target); }));
        startLearningBtn.addEventListener('click', ()=>switchTab('panel-2'));

        // Typing sound (WebAudio)
        const TYPING_SOUND_KEY = 'calciprep_typing_sound_enabled';
        let audioCtx = null;
        let typingSoundEnabled = false;
        
        const soundToggles = [
            document.getElementById('typing-sound-checkbox'),
            document.getElementById('words-sound-checkbox'),
            document.getElementById('paragraph-sound-checkbox')
        ];
        
        try { typingSoundEnabled = localStorage.getItem(TYPING_SOUND_KEY) === 'true'; } catch(e) { typingSoundEnabled = false; }

        function updateAllSoundToggles(isEnabled) {
            soundToggles.forEach(toggle => { if(toggle) toggle.checked = isEnabled; });
        }
        updateAllSoundToggles(typingSoundEnabled);

        function handleSoundToggleChange(ev){ 
            typingSoundEnabled = !!ev.target.checked; 
            try{ localStorage.setItem(TYPING_SOUND_KEY, typingSoundEnabled); }catch(e){} 
            updateAllSoundToggles(typingSoundEnabled);
            if(typingSoundEnabled && audioCtx && audioCtx.state==='suspended') audioCtx.resume(); 
        }
        soundToggles.forEach(toggle => { if(toggle) toggle.addEventListener('change', handleSoundToggleChange); });


        let clickBuffer = null;

        function ensureAudioContext(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx = null; } } }

        async function makeClickBuffers(){ 
            if(!audioCtx) return; 
            if(clickBuffer) return;

            try{
                const sampleRate = audioCtx.sampleRate;
                const renderBuffer = async (durationSec, toneFreq, noiseGain=0.35, toneGain=0.6, decay=6) => {
                    const len = Math.floor(sampleRate * durationSec);
                    const offline = new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(1, len, sampleRate);
                    const osc = offline.createOscillator(); osc.type = 'sine'; osc.frequency.value = toneFreq;
                    const toneGainNode = offline.createGain();
                    toneGainNode.gain.setValueAtTime(0.0001, 0);
                    toneGainNode.gain.linearRampToValueAtTime(toneGain, 0.002);
                    toneGainNode.gain.exponentialRampToValueAtTime(0.0001, durationSec);
                    osc.connect(toneGainNode); toneGainNode.connect(offline.destination);
                    const noiseBuf = offline.createBuffer(1, len, sampleRate);
                    const nd = noiseBuf.getChannelData(0);
                    for(let i=0;i<len;i++){ const t = i / len; nd[i] = (Math.random()*2 - 1) * Math.pow(1 - t, decay) * noiseGain; }
                    const noiseSrc = offline.createBufferSource(); noiseSrc.buffer = noiseBuf; noiseSrc.connect(offline.destination);
                    osc.start(0); noiseSrc.start(0);
                    return await offline.startRendering();
                };
                if(!clickBuffer) clickBuffer = await renderBuffer(0.06, 1600 + Math.random()*400, 0.25, 0.6, 20);
            }catch(e){
                const sampleRate = audioCtx.sampleRate;
                const clickLen = Math.floor(sampleRate * 0.06);
                const click = audioCtx.createBuffer(1, clickLen, sampleRate);
                const cdata = click.getChannelData(0);
                for(let i=0;i<clickLen;i++){ const t=i/clickLen; cdata[i]=(Math.random()*2-1)*(1-t)*0.4; }
                clickBuffer = click;
            }
        }

        function playTypeSound(key){ 
            if(!typingSoundEnabled) return; 
            try{
                ensureAudioContext(); 
                if(!audioCtx) return; 
                if(audioCtx.state==='suspended') audioCtx.resume();
                makeClickBuffers(); 
                if(!clickBuffer) return;
                const src = audioCtx.createBufferSource();
                const gain = audioCtx.createGain();
                src.buffer = clickBuffer; // ALWAYS use click buffer, no thud.
                gain.gain.value = 0.6 + Math.random()*0.3;
                src.connect(gain); gain.connect(audioCtx.destination);
                src.start();
            }catch(e){ /* ignore audio errors */ } 
        }

        // --- Generic Finalize/Calculation Logic ---
        function finalizeExercise(inputEl, displayEl, startTime, keystrokes, backspaces, showModalCallback) {
            const typedText = inputEl.value;
            const expectedText = displayEl.textContent;
            const durationMs = startTime ? (Date.now() - startTime) : 0;
            const minutes = (durationMs / 60000) || 0.00001;

            const typedWords = typedText.trim().split(/\s+/).filter(Boolean);
            const expectedWords = expectedText.trim().split(/\s+/).filter(Boolean);

            let correctChars = 0;
            for(let i = 0; i < typedText.length; i++) {
                if(i < expectedText.length && typedText[i] === expectedText[i]) correctChars++;
            }
            let correctWordsCount = 0;
            typedWords.forEach((word, i) => {
                if (word === expectedWords[i]) correctWordsCount++;
            });

            const totalCharsTyped = typedText.length;
            const totalMistakes = totalCharsTyped - correctChars;
            const grossWpm = Math.round((totalCharsTyped / 5) / minutes);
            const netWpm = Math.max(0, Math.round(grossWpm - (totalMistakes / 5 / minutes)));
            const grossWpm2 = Math.round(typedWords.length / minutes);
            const netWpm2 = Math.max(0, Math.round(correctWordsCount / minutes));
            const strokesPerMin = Math.round(keystrokes / minutes);
            const accuracy = totalCharsTyped > 0 ? Math.max(0, Math.round((correctChars / totalCharsTyped) * 100)) : 100;

            window.lastResult = { netWpm, accuracy }; // for minimized bar

            const formatDuration = ms => { const s=Math.floor(ms/1000); return `${String(Math.floor(s/60)).padStart(2,'0')} minutes ${String(s%60).padStart(2,'0')} seconds`; };

            // Populate Modal
            document.getElementById('res-duration').textContent = `: ${formatDuration(durationMs)}`;
            document.getElementById('res-correct-words').textContent = `: ${correctWordsCount}`;
            document.getElementById('res-total-words').textContent = `: ${typedWords.length}`;
            document.getElementById('res-incorrect-words').textContent = `: ${typedWords.length - correctWordsCount}`;
            document.getElementById('m1-net').textContent = `: ${netWpm} wpm`;
            document.getElementById('m1-gross').textContent = `: ${grossWpm} wpm`;
            document.getElementById('m1-net-strokes').textContent = `: ${strokesPerMin} kspm`;
            document.getElementById('m1-gross-strokes').textContent = `: ${strokesPerMin} kspm`;
            document.getElementById('m1-accuracy').textContent = `: ${accuracy}%`;
            document.getElementById('m1-backspace').textContent = `: ${backspaces} times`;
            document.getElementById('m2-net').textContent = `: ${netWpm2} wpm`;
            document.getElementById('m2-gross').textContent = `: ${grossWpm2} wpm`;
            document.getElementById('m2-net-strokes').textContent = `: ${strokesPerMin} kspm`;
            document.getElementById('m2-gross-strokes').textContent = `: ${strokesPerMin} kspm`;
            document.getElementById('m2-accuracy').textContent = `: ${accuracy}%`;
            document.getElementById('m2-backspace').textContent = `: ${backspaces} times`;
            
            showModalCallback();
        }

        // --- Original Panel-Specific Logic (with corrections) ---
        
        // Panel 2: Learn Keys
        let exercisesData = {};
        let currentCategory = '';
        let currentExerciseIndex = 0;
        const exerciseDisplay = document.getElementById('exercise-display-area');
        const typingInput = document.getElementById('typing-input-area');
        const categorySelect = document.getElementById('category-select');
        const exerciseSelect = document.getElementById('exercise-select');
        const prevBtn = document.getElementById('prev-exercise');
        const nextBtn = document.getElementById('next-exercise');
        const fontInc = document.getElementById('font-increase');
        const fontDec = document.getElementById('font-decrease');
        let currentFontSize = 1.5;
        const COMPLETED_KEY = 'calciprep_completed_exercises_v2';
        const completedExercises = new Set();
        try { /* ... */ } catch(e){ /* ... */ }
        let lk_keystrokeCount = 0, lk_backspaceCount = 0, lk_testStartTime = null;
        function lk_resetTracking(){ lk_keystrokeCount=0; lk_backspaceCount=0; lk_testStartTime=null; }
        function updateNavButtons(){ if(!currentCategory || !exercisesData[currentCategory]) return; const exercises = exercisesData[currentCategory]; prevBtn.disabled = currentExerciseIndex === 0; nextBtn.disabled = currentExerciseIndex === exercises.length - 1; }
        function renderExerciseText(text){ exerciseDisplay.innerHTML=''; text.split('').forEach(ch=>{ const s=document.createElement('span'); s.textContent=ch; exerciseDisplay.appendChild(s); }); if (exerciseDisplay.firstChild) exerciseDisplay.firstChild.classList.add('current-char');}
        function populateCategorySelect(){ if(!categorySelect) return; categorySelect.innerHTML = ''; Object.keys(exercisesData).forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1).replace('_', ' '); categorySelect.appendChild(opt); }); if(Object.keys(exercisesData).length > 0) { currentCategory = Object.keys(exercisesData)[0]; categorySelect.value = currentCategory; populateExerciseSelect(); }}
        function populateExerciseSelect(){ if(!exerciseSelect || !currentCategory || !exercisesData[currentCategory]) return; exerciseSelect.innerHTML = ''; const exercises = exercisesData[currentCategory]; exercises.forEach((ex, idx)=>{ const opt = document.createElement('option'); opt.value = idx; const exerciseKey = `${currentCategory}_${idx}`; const prefix = completedExercises.has(exerciseKey) ? '✅ ' : ''; opt.textContent = `${prefix}Exercise ${idx+1}`; exerciseSelect.appendChild(opt); }); exerciseSelect.value = currentExerciseIndex; }
        function loadExercise(category, exerciseIndex){ if(!exercisesData[category] || !exercisesData[category].length) return; currentCategory = category; currentExerciseIndex = Math.max(0, Math.min(exerciseIndex, exercisesData[category].length-1)); renderExerciseText(exercisesData[currentCategory][currentExerciseIndex]); typingInput.value=''; typingInput.focus(); lk_resetTracking(); updateNavButtons(); if(exerciseSelect) exerciseSelect.value = currentExerciseIndex; if(categorySelect) categorySelect.value = currentCategory;}
        prevBtn.addEventListener('click', ()=>{ if(currentExerciseIndex > 0) { loadExercise(currentCategory, currentExerciseIndex - 1); } });
        nextBtn.addEventListener('click', ()=>{ if(currentCategory && exercisesData[currentCategory] && currentExerciseIndex < exercisesData[currentCategory].length - 1) { loadExercise(currentCategory, currentExerciseIndex + 1); } });
        if(categorySelect) { categorySelect.addEventListener('change', (e) => { currentCategory = e.target.value; currentExerciseIndex = 0; populateExerciseSelect(); loadExercise(currentCategory, 0); }); }
        if(exerciseSelect) { exerciseSelect.addEventListener('change', (e) => { const v = parseInt(e.target.value, 10); if (!Number.isNaN(v)) { loadExercise(currentCategory, v); } }); }
        fontInc.addEventListener('click', ()=>{ currentFontSize = Math.min(2.5, currentFontSize+0.1); exerciseDisplay.style.fontSize = `${currentFontSize}rem`; });
        fontDec.addEventListener('click', ()=>{ currentFontSize = Math.max(1.0, currentFontSize-0.1); exerciseDisplay.style.fontSize = `${currentFontSize}rem`; });
        typingInput.addEventListener('keydown', (e)=>{ if(!lk_testStartTime) lk_testStartTime = Date.now(); if(e.key==='Backspace') lk_backspaceCount++; const isChar = (e.key.length===1 || e.key===' ' || e.key==='Enter'); if(isChar){ lk_keystrokeCount++; playTypeSound(e.key); } });
        typingInput.addEventListener('input', ()=>{
            const typed = typingInput.value || '';
            const spans = exerciseDisplay.querySelectorAll('span');
            spans.forEach((s,i)=>{ s.classList.remove('correct-char','incorrect-char','current-char'); if(i < typed.length) s.classList.add(typed[i]===s.textContent ? 'correct-char' : 'incorrect-char'); else if(i===typed.length) s.classList.add('current-char'); });
            const expected = exerciseDisplay.textContent || '';
            if(typed.length>0 && typed.length >= expected.length) finalizeLearnKeysExercise();
        });
        function finalizeLearnKeysExercise() {
            finalizeExercise(typingInput, exerciseDisplay, lk_testStartTime, lk_keystrokeCount, lk_backspaceCount, showResultModal);
            const exerciseKey = `${currentCategory}_${currentExerciseIndex}`;
            completedExercises.add(exerciseKey);
            try{ localStorage.setItem(COMPLETED_KEY, JSON.stringify(Array.from(completedExercises))); }catch(e){}
            populateExerciseSelect();
        }
        document.getElementById('typing-submit').addEventListener('click', (e)=>{ e.preventDefault(); if(!lk_testStartTime) lk_testStartTime = Date.now(); finalizeLearnKeysExercise(); });
        fetch('/data/learn-keys-exercises.json').then(r=>r.ok ? r.json() : Promise.reject(r)).then(json=>{ exercisesData = json.categories; populateCategorySelect(); if(Object.keys(exercisesData).length > 0) { loadExercise(Object.keys(exercisesData)[0], 0); } }).catch(err=>{ console.error(err); exerciseDisplay.textContent='No exercises found.'; });

        // Panel 3: Practice Words
        let practiceWords = [];
        let currentWordsCategory = 'basic';
        const wordsDisplay = document.getElementById('words-display-area');
        const wordsInput = document.getElementById('words-typing-input');
        const wordsSelect = document.getElementById('words-select');
        const prevWordsBtn = document.getElementById('prev-words');
        const nextWordsBtn = document.getElementById('next-words');
        const wordsFontInc = document.getElementById('words-font-increase');
        const wordsFontDec = document.getElementById('words-font-decrease');
        let currentWordsFontSize = 1.5;
        let wordsTestStartTime = null;
        let wordsKeystrokeCount = 0;
        let wordsBackspaceCount = 0;

        function renderWordsText(words) { wordsDisplay.innerHTML = ''; const text = words.join(' '); text.split('').forEach(ch => { const s = document.createElement('span'); s.textContent = ch; wordsDisplay.appendChild(s); }); if(wordsDisplay.firstChild) wordsDisplay.firstChild.classList.add('current-char');}
        function populateWordsSelect() { if (!wordsSelect || !window.practiceWordsData) return; wordsSelect.innerHTML = ''; const categories = Object.keys(window.practiceWordsData.categories); categories.forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat.charAt(0).toUpperCase() + cat.slice(1); wordsSelect.appendChild(opt); }); wordsSelect.value = currentWordsCategory; }
        function loadWords(category) { currentWordsCategory = category; practiceWords = window.practiceWordsData?.categories[category] || []; if (practiceWords.length > 0) { renderWordsText(practiceWords); wordsInput.value = ''; wordsInput.focus(); resetWordsTracking(); } else { wordsDisplay.textContent = 'No words found for this category.'; }}
        function resetWordsTracking() { wordsTestStartTime = null; wordsKeystrokeCount = 0; wordsBackspaceCount = 0; }
        if (prevWordsBtn) prevWordsBtn.addEventListener('click', () => loadWords(currentWordsCategory));
        if (nextWordsBtn) nextWordsBtn.addEventListener('click', () => loadWords(currentWordsCategory));
        if (wordsSelect) wordsSelect.addEventListener('change', (e) => loadWords(e.target.value));
        if (wordsFontInc) wordsFontInc.addEventListener('click', () => { currentWordsFontSize = Math.min(2.5, currentWordsFontSize + 0.1); wordsDisplay.style.fontSize = `${currentWordsFontSize}rem`; });
        if (wordsFontDec) wordsFontDec.addEventListener('click', () => { currentWordsFontSize = Math.max(1.0, currentWordsFontSize - 0.1); wordsDisplay.style.fontSize = `${currentWordsFontSize}rem`; });
        if (wordsInput) {
            wordsInput.addEventListener('keydown', (e)=>{ if(!wordsTestStartTime) wordsTestStartTime = Date.now(); if(e.key==='Backspace') wordsBackspaceCount++; const isChar = (e.key.length===1 || e.key===' ' || e.key==='Enter'); if(isChar){ wordsKeystrokeCount++; playTypeSound(e.key); } });
            wordsInput.addEventListener('input', () => {
                const typed = wordsInput.value || '';
                const spans = wordsDisplay.querySelectorAll('span');
                spans.forEach((s, i) => { s.classList.remove('correct-char', 'incorrect-char', 'current-char'); if (i < typed.length) { s.classList.add(typed[i] === s.textContent ? 'correct-char' : 'incorrect-char'); } else if (i === typed.length) { s.classList.add('current-char'); } });
                if (typed.length > 0 && typed.length >= wordsDisplay.textContent.length) finalizeWordsExercise();
            });
        }
        function finalizeWordsExercise() { finalizeExercise(wordsInput, wordsDisplay, wordsTestStartTime, wordsKeystrokeCount, wordsBackspaceCount, showResultModal); }
        if (document.getElementById('words-submit')) document.getElementById('words-submit').addEventListener('click', (e) => { e.preventDefault(); if(!wordsTestStartTime) wordsTestStartTime = Date.now(); finalizeWordsExercise(); });
        fetch('/data/practice-words.json').then(r => r.ok ? r.json() : Promise.reject(r)).then(json => { window.practiceWordsData = json; populateWordsSelect(); loadWords('basic'); }).catch(err => { console.error(err); if (wordsDisplay) wordsDisplay.textContent = 'Could not load practice words.'; });

        // Panel 4: Type Paragraphs
        let paragraphs = [];
        let currentParagraphIndex = 0;
        const paragraphDisplay = document.getElementById('paragraph-display-area');
        const paragraphInput = document.getElementById('paragraph-typing-input');
        const paragraphSelect = document.getElementById('paragraph-select');
        const prevParagraphBtn = document.getElementById('prev-paragraph');
        const nextParagraphBtn = document.getElementById('next-paragraph');
        const paragraphFontInc = document.getElementById('paragraph-font-increase');
        const paragraphFontDec = document.getElementById('paragraph-font-decrease');
        let currentParagraphFontSize = 1.5;
        let paragraphTestStartTime = null;
        let paraKeystrokeCount = 0;
        let paraBackspaceCount = 0;

        function renderParagraphText(text) { paragraphDisplay.innerHTML = ''; text.split('').forEach(ch => { const s = document.createElement('span'); s.textContent = ch; paragraphDisplay.appendChild(s); }); if(paragraphDisplay.firstChild) paragraphDisplay.firstChild.classList.add('current-char');}
        function populateParagraphSelect() { if (!paragraphSelect) return; paragraphSelect.innerHTML = ''; paragraphs.forEach((para, idx) => { const opt = document.createElement('option'); opt.value = idx; opt.textContent = `Paragraph ${idx + 1}`; paragraphSelect.appendChild(opt); }); paragraphSelect.value = currentParagraphIndex; }
        function loadParagraph(index) { if (!paragraphs || !paragraphs.length) return; currentParagraphIndex = Math.max(0, Math.min(index, paragraphs.length - 1)); renderParagraphText(paragraphs[currentParagraphIndex]); paragraphInput.value = ''; paragraphInput.focus(); resetParagraphTracking(); if (paragraphSelect) paragraphSelect.value = currentParagraphIndex; prevParagraphBtn.disabled = currentParagraphIndex === 0; nextParagraphBtn.disabled = currentParagraphIndex === paragraphs.length - 1; }
        function resetParagraphTracking() { paragraphTestStartTime = null; paraKeystrokeCount = 0; paraBackspaceCount = 0; }
        if (prevParagraphBtn) prevParagraphBtn.addEventListener('click', () => { if (currentParagraphIndex > 0) loadParagraph(currentParagraphIndex - 1); });
        if (nextParagraphBtn) nextParagraphBtn.addEventListener('click', () => { if (currentParagraphIndex < paragraphs.length - 1) loadParagraph(currentParagraphIndex + 1); });
        if (paragraphSelect) paragraphSelect.addEventListener('change', (e) => { const v = parseInt(e.target.value, 10); if (!Number.isNaN(v)) loadParagraph(v); });
        if (paragraphFontInc) paragraphFontInc.addEventListener('click', () => { currentParagraphFontSize = Math.min(2.5, currentParagraphFontSize + 0.1); paragraphDisplay.style.fontSize = `${currentParagraphFontSize}rem`; });
        if (paragraphFontDec) paragraphFontDec.addEventListener('click', () => { currentParagraphFontSize = Math.max(1.0, currentParagraphFontSize - 0.1); paragraphDisplay.style.fontSize = `${currentParagraphFontSize}rem`; });
        if (paragraphInput) {
            paragraphInput.addEventListener('keydown', (e)=>{ if(!paragraphTestStartTime) paragraphTestStartTime = Date.now(); if(e.key==='Backspace') paraBackspaceCount++; const isChar = (e.key.length===1 || e.key===' ' || e.key==='Enter'); if(isChar){ paraKeystrokeCount++; playTypeSound(e.key); } });
            paragraphInput.addEventListener('input', () => {
                const typed = paragraphInput.value || '';
                const spans = paragraphDisplay.querySelectorAll('span');
                spans.forEach((s, i) => { s.classList.remove('correct-char', 'incorrect-char', 'current-char'); if (i < typed.length) { s.classList.add(typed[i] === s.textContent ? 'correct-char' : 'incorrect-char'); } else if (i === typed.length) { s.classList.add('current-char'); } });
                if (typed.length > 0 && typed.length >= paragraphDisplay.textContent.length) finalizeParagraphExercise();
            });
        }
        function finalizeParagraphExercise() { finalizeExercise(paragraphInput, paragraphDisplay, paragraphTestStartTime, paraKeystrokeCount, paraBackspaceCount, showResultModal); }
        if (document.getElementById('paragraph-submit')) document.getElementById('paragraph-submit').addEventListener('click', (e) => { e.preventDefault(); if(!paragraphTestStartTime) paragraphTestStartTime = Date.now(); finalizeParagraphExercise(); });
        fetch('/data/type-paragraphs.json').then(r => r.ok ? r.json() : Promise.reject(r)).then(json => { paragraphs = json; if (paragraphs.length) { populateParagraphSelect(); loadParagraph(0); } else { if (paragraphDisplay) paragraphDisplay.textContent = 'No paragraphs found.'; } }).catch(err => { console.error(err); if (paragraphDisplay) paragraphDisplay.textContent = 'Could not load paragraphs.'; });

        // --- Result Modal Logic ---
        const modal = document.getElementById('result-modal');
        const minBar = document.getElementById('result-minimized');
        function showResultModal(){ modal.classList.remove('hidden'); minBar.classList.add('hidden'); }
        function hideResultModal(){ modal.classList.add('hidden'); }
        document.getElementById('res-close').addEventListener('click', (e)=>{ e.preventDefault(); hideResultModal(); minBar.classList.add('hidden'); });
        document.getElementById('res-minimize').addEventListener('click', ()=>{ hideResultModal(); const r = window.lastResult || {}; document.getElementById('min-summary').textContent = `Net: ${r.netWpm||0} WPM · Acc: ${r.accuracy||0}%`; minBar.classList.remove('hidden'); });
        document.getElementById('min-restore').addEventListener('click', ()=>{ minBar.classList.add('hidden'); showResultModal(); });
        document.getElementById('res-repeat').addEventListener('click', (e)=>{ e.preventDefault(); hideResultModal(); /* Logic to repeat is handled by the specific panel's load function */ });
        document.getElementById('res-next').addEventListener('click', (e)=>{ e.preventDefault(); hideResultModal(); /* Logic to go next is handled by the specific panel's next button logic */ });

        if(typeof lucide !== 'undefined') lucide.createIcons();
    });
    </script>
</body>
</html>

